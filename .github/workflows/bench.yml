name: Rust Bench
on:
  pull_request:
    paths:
    - 'rust/candid/**'
jobs:
  runBenchMark:
    name: run benchmark
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Checkout base branch
      uses: actions/checkout@v4
      with:
        ref: ${{ github.base_ref }}
        path: main/
    - name: Install stable toolchain
      uses: actions-rs/toolchain@v1
      with:
        profile: minimal
        toolchain: stable
        override: true
    - name: Cache cargo build
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-bench-${{ hashFiles('**/Cargo.lock') }}
    - name: Install canbench
      run: cargo install canbench
    - name: Run perf for base branch
      run: |
        ls -al
        pushd main/rust/bench
        canbench --persist
        popd
        cp main/rust/bench/canbench_results.yml rust/bench/
    - name: Run perf for PR beanch
      run: |
        pushd rust/bench
        canbench > /tmp/perf.txt
    - name: Post comment
      uses: thollander/actions-comment-pull-request@v2
      with:
        filePath: /tmp/perf.txt
        comment_tag: canbench

